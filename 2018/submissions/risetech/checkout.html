<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="js/stellar-sdk.js"></script>
<script src="js/jquery.js"></script>
</head>
<body>
    <div class="container">
    <div class="row">
        
       <div class="col-md-4 ">
        <div class="card" style="width: 18rem;">
  <div class="card-body">
    <h5 class="card-title">Create Account</h5>
    <h6 class="card-subtitle mb-2 text-muted">you need stellar account to continue.. </h6>
    <p class="card-text">
      <strong>
          click button below to create Account 
      </strong></p>
    <button class="btn btn-success" onclick="CreateAccount()">generate #1</button>
    <button class="btn btn-success" onclick="CreateAccount1()">generate #2</button>
    <div id="display"> </div>
</div>
    </div></div>
       <div class="col-md-4"><div class="card">
  <div class="card-header">
    checkout
    
  </div>
  <div class="card-body">
      <label for="basic-url">key</label>
<div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon3">issuer key</span>
  </div>
  <input type="text" class="form-control" id="issuer_key" aria-describedby="basic-addon3">
</div>
 
 <label for="basic-url">key</label>
<div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon3">distributor key</span>
  </div>
  <input type="text" class="form-control" id="distribution_key" aria-describedby="basic-addon3">
</div>
 
  <label for="basic-url">token code</label>
<div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="">token </span>
  </div>
  <input type="text" class="form-control" id="asset_code" aria-describedby="basic-addon3">
</div>
 
 
 <label for="basic-url">Amount</label>
<div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="sell_asset_amount">Amount </span>
  </div>
  <input type="text" class="form-control" id="amount" aria-describedby="basic-addon3">
  
  
</div>
 
 
 <label for="basic-url">home domain</label>
<div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="home_domain">domain </span>
  </div>
  <input type="text" class="form-control" id="distribution_key" aria-describedby="basic-addon3">
  
  
</div>
                      <div class="form-group col-sm-6 col-xs-12">
                      <p></p>
                      <input class="form-control input-lg" type="text" id="market" name="market" placeholder="Token price in XLM" style="display:none"/>
                    </div>
                    <div class="form-group col-sm-6 col-xs-12" >
                      <p></p>
                      <input class="form-control input-lg" type="text" id="empty" name="xxxxxxxxxxxxxxxxxxxx" placeholder=" " style="visibility: hidden"/>
                    </div>

  <button class="btn btn-primary" onclick="createToken()"> Generate token</button>
  
<!--                <p id="reponse"></p>-->
                <p id="asset_name"></p>
                <p id="issuer_secret_key"></p>
                <p id="distribution_Secret_key"></p>
  </div>
</div></div>
        
       <div class="col-md-4 ">
        <div class="card" style="width: 18rem;">
  <div class="card-body">
   <div id="" class="alert alert-primary">
      <center> Account info</center>
       <p id="reponse"></p>
   </div>
    <h6 class="card-subtitle mb-2 text-muted">&nbsp; </h6>
    <p class="card-text">
      <strong>
         
      </strong></p>
    <a class="btn btn-success" href="real.html" id="offer_btn">Create an Offer</a>
    <div id="display"> </div>
</div>
    </div></div>
    </div>
    
    </div>
     <script>

 
var pair="";

function CreateAccount() {
      var display = document.getElementById("display");
 pair = StellarSdk.Keypair.random();
    var pk1 = pair.secret();

var secretkey = pair.secret();
var publickey =pair.publicKey();
//display.innerHTML = "Private Key: "+pair.secret();
   var pk11 = document.getElementById('issuer_key');    
    pk11.value = secretkey;
    
    
    
//    document.getElementById('gadget_url').value = pk1;
//    +"<br>Public Key: "+pair.publicKey();

// display.innerHTML += "<br><br>Sending test XLM to the account... <br>";
 
// ONLY ON TESTNET. THE CODE BELOW FUNDS THE ACCOUNT WITH 10,000 XLM.
var server = new StellarSdk.Server('https://horizon-testnet.stellar.org');

   $.ajax({
    type: "POST",
    url: "https://friendbot.stellar.org",
    data: {addr: publickey},
    dataType:'JSON', 
    success: function(response){

 display.innerHTML += "<br>Account funded with 10,000 XLM";

    }
});

  }
         

function CreateAccount1() {
      var display = document.getElementById("display");
 pair = StellarSdk.Keypair.random();
    var pk1 = pair.secret();

var secretkey = pair.secret();
var publickey =pair.publicKey();
    
    
    $("#offer_btn").attr("href","real.html?publickey="+publickey);
    
//display.innerHTML = "Private Key: "+pair.secret();
   var pk12 = document.getElementById('distribution_key');    
    pk12.value = secretkey;
    
    
    
//    document.getElementById('gadget_url').value = pk1;
//    +"<br>Public Key: "+pair.publicKey();

// display.innerHTML += "<br><br>Sending test XLM to the account... <br>";
 
// ONLY ON TESTNET. THE CODE BELOW FUNDS THE ACCOUNT WITH 10,000 XLM.
var server = new StellarSdk.Server('https://horizon-testnet.stellar.org');

   $.ajax({
    type: "POST",
    url: "https://friendbot.stellar.org",
    data: {addr: publickey},
    dataType:'JSON', 
    success: function(response){

 display.innerHTML += "<br>Account funded with 10,000 XLM";

    }
});

  } 
 function GetAccount(){
 
 var display = document.getElementById("display");
 
var server = new StellarSdk.Server('https://horizon-testnet.stellar.org');

// the JS SDK uses promises for most actions, such as retrieving an account
server.loadAccount(pair.publicKey()).then(function(account) {
 display.innerHTML += '<br><br><br>Getting Balances for account: ' + pair.publicKey();
  account.balances.forEach(function(balance) {
   //console.log('Type:', balance.asset_type, ', Balance:', balance.balance);
     display.innerHTML += "<br>Type:"+ balance.asset_type + ', Balance:'+balance.balance;
  });
});

 }

  function createToken() {
//Asset_code
var asset_code = document.getElementById('asset_code').value;
   //Amount of Asset to float on Market
var sell_asset_amount = document.getElementById('sell_asset_amount').value;

    if (asset_code.length < 4 || asset_code.length > 12 ) {
alert("Please use atleast 4 Characters in Token");
} else if(sell_asset_amount >limit_amount){
  alert("Please issue less tokens on the exchange");
}else{
// document.getElementById('waitingimg').style.display = "block";
//      document.getElementById('reponse').style.display="none";
    // body...
    StellarSdk.Network.useTestNetwork();
var server = new StellarSdk.Server('https://horizon-testnet.stellar.org');

//issuer_key
var issuer_key = document.getElementById('issuer_key').value;
//distribution_key
var distribution_key = document.getElementById('distribution_key').value;

//"SBAMMGVGJBJ54V4YUTEILN3MF2TB57IT5WYMQZ6XIUN6WV5Z6VD75Q2Z"

//limit
var limit_amount = document.getElementById('amount').value.toString();


var exchange_box =document.getElementById('exchange');
var lock_box =document.getElementById('lock');



//Price for Asset on Market
var market = document.getElementById('market').value; 

// Keys for accounts to issue and receive the new asset
// var issuingKeys = StellarSdk.Keypair
//   .fromSecret('SCZANGBA5YHTNYVVV4C3U252E2B6P6F5T3U6MM63WBSBZATAQI3EBTQ4');
// var receivingKeys = StellarSdk.Keypair
//   .fromSecret('SDSAVCRE5JRAI7UFAVLE5IMIZRD6N6WOJUWKY4GFN34LOBEEUS4W2T2D');

try{var issuingKeys = StellarSdk.Keypair
  .fromSecret(issuer_key);
var receivingKeys = StellarSdk.Keypair
  .fromSecret(distribution_key);
// Create an object to represent the new asset
var astroDollar = new StellarSdk.Asset(asset_code, issuingKeys.publicKey());
} catch (err){
//    document.getElementById('waitingimg').style.display = "none";
//      document.getElementById('reponse').style.display="block";
      document.getElementById('reponse').innerHTML = "Token Failed due to Invalid Keys";
//      document.getElementById("requestACall").reset();
}
// First, the receiving account must trust the asset
server.loadAccount(receivingKeys.publicKey())
  .then(function(receiver) {
    var transaction = new StellarSdk.TransactionBuilder(receiver)
      // The `changeTrust` operation creates (or alters) a trustline
      // The `limit` parameter below is optional
      .addOperation(StellarSdk.Operation.changeTrust({
        asset: astroDollar,
        limit: limit_amount
      }))
      .build();
    transaction.sign(receivingKeys);
    return server.submitTransaction(transaction);
  })

  // Second, the issuing account actually sends a payment using the asset
  .then(function() {
    return server.loadAccount(issuingKeys.publicKey())
  })
  /*.then(function(issuer) {
      if(exchange_box.checked == true){
    var transaction = new StellarSdk.TransactionBuilder(issuer)
      .addOperation(StellarSdk.Operation.manageOffer({
        selling: astroDollar,
        buying: StellarSdk.Asset.native(),
        amount: sell_asset_amount,
        price : market
      }))
      .build();
    transaction.sign(issuingKeys);
   
    return server.submitTransaction(transaction);
      }else{
          //do nothing
      }
  })*/
  .then(function(issuer) {

    if (exchange_box.checked == true && lock_box.checked == true) {
         var transaction = new StellarSdk.TransactionBuilder(issuer)
      .addOperation(StellarSdk.Operation.payment({
        destination: receivingKeys.publicKey(),
        asset: astroDollar,
        amount: limit_amount
      })).addOperation(StellarSdk.Operation.setOptions({
                lowThreshold : "1",
                medThreshold : "2",
                highThreshold : "3",
                source : issuingKeys.publicKey()

     })).addOperation(StellarSdk.Operation.manageOffer({
        selling: astroDollar,
        buying: StellarSdk.Asset.native(),
        amount: sell_asset_amount,
        price : market
      })).addOperation(StellarSdk.Operation.setOptions({
        homeDomain: document.getElementById("home_domain").value
      }))
      .build();
    transaction.sign(issuingKeys);
   
    return server.submitTransaction(transaction);
   
  } else if (exchange_box.checked == false && lock_box.checked == true) {
      var transaction = new StellarSdk.TransactionBuilder(issuer)
      .addOperation(StellarSdk.Operation.payment({
        destination: receivingKeys.publicKey(),
        asset: astroDollar,
        amount: limit_amount
      })).addOperation(StellarSdk.Operation.setOptions({
                lowThreshold : "1",
                medThreshold : "2",
                highThreshold : "3",
                source : issuingKeys.publicKey()

     })).addOperation(StellarSdk.Operation.setOptions({
        homeDomain: document.getElementById("home_domain").value
      }))
      .build();
    transaction.sign(issuingKeys);
   
    return server.submitTransaction(transaction);
  }else if (exchange_box.checked == true && lock_box.checked == false) {
      var transaction = new StellarSdk.TransactionBuilder(issuer)
      .addOperation(StellarSdk.Operation.payment({
        destination: receivingKeys.publicKey(),
        asset: astroDollar,
        amount: limit_amount
      })).addOperation(StellarSdk.Operation.manageOffer({
        selling: astroDollar,
        buying: StellarSdk.Asset.native(),
        amount: sell_asset_amount,
        price : market
      })).addOperation(StellarSdk.Operation.setOptions({
        homeDomain: document.getElementById("home_domain").value
      }))
      .build();
    transaction.sign(issuingKeys);
   
    return server.submitTransaction(transaction);
  }else if (exchange_box.checked == false && lock_box.checked == false)   {
          var transaction = new StellarSdk.TransactionBuilder(issuer)
      .addOperation(StellarSdk.Operation.payment({
        destination: receivingKeys.publicKey(),
        asset: astroDollar,
        amount: limit_amount,
        
      })).addOperation(StellarSdk.Operation.setOptions({
        homeDomain: document.getElementById("home_domain").value
      }))
      .build();
    transaction.sign(issuingKeys);
   
    return server.submitTransaction(transaction);
  }
  
 

 
  })
  .then(function(issuer) {

    if( distribution_key == "SBAMMGVGJBJ54V4YUTEILN3MF2TB57IT5WYMQZ6XIUN6WV5Z6VD75Q2Z"){
        //SBAMMGVGJBJ54V4YUTEILN3MF2TB57IT5WYMQZ6XIUN6WV5Z6VD75Q2Z
     database_register(receivingKeys.publicKey(),issuingKeys.publicKey(),asset_code);
    }else{
        // do nothing
//        document.getElementById('reponse').style.display="block";
//    document.getElementById('distribution_Secret_key').style.display="none";
//    document.getElementById('asset_name').style.display="none";
//    document.getElementById('issuer_secret_key').style.display="none";
//    document.getElementById('waitingimg').style.display = "none";

    document.getElementById('reponse').innerHTML = "Successfully Created Token<br>Token Code: "+ asset_code+"<br>Issuer: "+issuer_key+"<br>Distributor: "+distribution_key+"<br>Please store keys to avoid losing accounts";

    // // document.getElementById('distribution_Secret_key').innerHTML = "Token Distributor :- "+receiving_key;
    // // console.log(receiving_key);
    // document.getElementById('asset_name').innerHTML = "Token :- "+asset_namez;
    // document.getElementById('issuer_secret_key').innerHTML = "Token Issuer:- "+ issuer_keyz;
//    document.getElementById("requestACall").reset();
    }
   
  })
  .catch(function(error) {
    console.error('Error!', error);
  
//    document.getElementById('waitingimg').style.display = "none";
//      document.getElementById('reponse').style.display="block";
      document.getElementById('reponse').innerHTML =  "Successfully Created Token<br>Token Code: "+ asset_code+"<br>Issuer: "+issuer_key+"<br>Distributor: "+distribution_key+"<br>Please store keys to avoid losing accounts";
//      document.getElementById("requestACall").reset();

  });

  }


  function database_register(receiving_key,issuer_keyz,asset_namez) {
   $.ajax({
    type: "POST",
    url: "https://clicmonkey.xyz/tokenmaker/assetregister.php",
    data: {asset_name: asset_namez,issuer_key: issuer_keyz},
    dataType:'JSON', 
    success: function(response){
       // console.log(response);

//    document.getElementById('reponse').style.display="block";
//    document.getElementById('distribution_Secret_key').style.display="none";
//    document.getElementById('asset_name').style.display="none";
//    document.getElementById('issuer_secret_key').style.display="none";
//    document.getElementById('waitingimg').style.display = "none";

    document.getElementById('reponse').innerHTML = "Successfully Created Token";
    document.getElementById('distribution_Secret_key').innerHTML = "Token Distributor :- "+receiving_key;
    console.log(receiving_key);
    document.getElementById('asset_name').innerHTML = "Token :- "+asset_namez;
    document.getElementById('issuer_secret_key').innerHTML = "Token Issuer:- "+ issuer_keyz;
//    document.getElementById("requestACall").reset();

    }
});

}

    
  }         
 </script>
    </body>
</html>